<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>URLs amigables utilizando NGINX y docker</title><link rel="stylesheet" href="/main.css"><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet"></head><body><header class="header"><div class="header-container"><h1 class="title"><a href="/">ROOFOX.dev</a></h1></div></header><main><article class="post"><section class="post-meta"><h1 class="post-title">URLs amigables utilizando NGINX y docker</h1><time class="post-list-time">marzo 29, 2019</time></section><section class="post-content"><p>Todos los programadores web conocemos perfectamente el concepto de qu√© es <em>localhost</em>, ya que diariamente trabajamos con el para acceder y probar nuestros sitios web.</p><blockquote><p><em>localhost</em> es el nombre del equipo local o <em>"este equipo"</em> el cual tiene la direcci√≥n IP <em>127.0.0.1</em>.</p></blockquote><p>Como todos sabemos, si ingresamos la URL http://localhost/ en el navegador estaremos accediendo al puerto 80 del equipo local y si tenemos un servidor web como <a href="https://httpd.apache.org/">apache</a> o <a href="https://nginx.org/">nginx</a> escuchando en ese puerto es probable que el navegador web nos muestre el sitio web que se encuentre configurado o en su defecto una p√°gina de bienvenida del servidor web.</p><p>Y bueno, no es muy com√∫n ejecutar aplicaciones en el puerto 80 cuando estamos programando, generalmente utilizamos otro puerto como el 3000 o similares, esto nos proporciona la ventaja de ejecutar varias aplicaciones en el equipo local sin necesidad de tener un servidor remoto para la ejecuci√≥n de cada aplicaci√≥n.</p><p>Un caso muy com√∫n hoy en d√≠a es el programar el frontend y el backend como proyectos separados, cada uno ejecutandose en un puerto independiente, lo que nos lleva a tener que utilizar dos URLs del tipo <em>localhost:&lt;puerto&gt;</em>, pero, <em>¬øno ser√≠a genial poder utilizar algo como <a href="http://superhero-app.com/">http://superhero-app.com/</a> para acceder al frontend y <a href="http://api.superhero-app.com">http://api.superhero-app.com</a> para la API/backend?</em> Podemos hacerlo üòé.</p><h2>Primeros pasos</h2><p>El objetivo de este ejemplo es el de realizar un redireccionamiento utilizando <a href="https://nginx.org/">nginx</a> para que cuando ingresemos a <a href="http://my-node-app.com">http://my-node-app.com</a> internamente el servidor web redireccione las peticiones a la direci√≥n y puerto local expuestas por <a href="https://www.docker.com/">docker</a> (o cualquier otro proyecto ejecutandose en la maquina local).</p><p>El flujo general ‚Äî el que al final de esta publicaci√≥n deber√≠as entender mejor ‚Äî es a como se muestra en el siguiente diagrama:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAJCAYAAAAGuM1UAAAA/UlEQVR4AXXBvU7DMBSA0c/2jZ04UdQBCgMszLCx9AF4AN6akQXEipgQQ0XV5sduchFISBES55hxVN3vR2IMGAO7XUfbRlRhGDIxFkwTpHQkRkGsBe8dXbcHlBBKrAVVCEGwFlTBe4e1ICJQ146madhvH9i+vyBn18T2FlUwBkRAFYwBYSHEK84v1+RjoO97vPc451gSFoqw5vPjkTQeaBpBdYVWG4wRfln+aE/uOL24p+89b69P5O6ZJeEfq/WGqr1hODry4UBZljjnkJwhZxDhR0ozxsykJMzzCucUR2AYLCGAVYVxTKiCKgzDSFEUVFVEpKCua6wVpmni2xdSO2EcCFa3xQAAAABJRU5ErkJggg==" alt="Diagrama de flujo" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/diagrama-de-flujo.png" class="ab" width="826" height="601"></p><h1>Sofware necesario</h1><p>Utilizaremos un ambiente linux para la demostraci√≥n del ejemplo, <a href="https://www.ubuntu.com/">ubuntu</a> <code>v18.04.2 LTS</code> ser√° el sistema operativo y necesitaremos la instalaci√≥n de los siguientes programas:</p><ul><li><a href="https://www.docker.com/">docker</a> <code>v18.09.3</code></li><li><a href="https://docs.docker.com/compose/">docker-compose</a> <code>v1.23.2</code></li><li><a href="https://www.git-scm.com/">git</a> <code>v2.17.1</code></li></ul><blockquote><p>Este ejemplo puede ejecutarse f√°cilmente en otros sistemas operativos como <code>Windows</code> o <code>macOS</code> siguiendo la mayor√≠a de las instrucciones.</p></blockquote><h2>Ejecutar las aplicaciones de ejemplo</h2><p>Vamos a crear un archivo <a href="/assets/blog/urls-amigables-utilizando-nginx-y-docker/docker-compose.yml"><code>docker-compose.yml</code></a> en la ruta que prefieras al cual agregar√°s el siguiente contenido:</p><pre class="code-segment line-numbers" data-language="yaml"><code class="language-yaml">version: "3.5"
services:
    node:
        container_name: cc9a-nginx-docker-node
        image: roofox/cc9a-nginx-docker-node:0.1
        ports:
            - "3618:80"
        networks: 
            - nginx-docker-network
    python:
        container_name: cc9a-nginx-docker-python
        image: roofox/cc9a-nginx-docker-python:0.1
        ports:
            - "3620:80"
    php:
        container_name: cc9a-nginx-docker-php
        image: roofox/cc9a-nginx-docker-php:0.1
        ports:
            - "3622:80"
networks:
    nginx-docker-network:
        name: cc9a-nginx-docker-network
        driver: bridge
</code></pre><p>Como puedes ver, estamos creando tres servicios en los cuales vamos a exponer en un puerto diferente un servidor web utilizando lenguajes de programaci√≥n diferentes, en cada servicio se mostrar√° un texto de ejemplo generado desde cada uno de ellos.</p><p>Vamos a posicionarnos desde la l√≠nea de comandos en el directorio donde creamos el archivo <code>docker-compose.yml</code> y ejecutaremos el comando <code>docker-compose up</code>.</p><p><a href="docker">Docker</a> comenzar√° a descargar las imagenes de los servicios (tardar√° unos cuantos minutos) para finalmente mostrarlos en ejecuci√≥n.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAA00lEQVR4AZXBS04DMRBF0VsuO3RCYFOICfvfACNEhoS0++Oqh4LEAjjH3l5fBAJBKYVUUszBYF1XlMmfU3VqXMTBnNh2SnPm60zEQBIZYltWUmLtC3e1BuyxYQYRg9YafbkiQW78MmA6HTEz6tf3B9uyYsVwO+Jl4nR8JiJJH7TDgT53pEQpajuceZiesWI0nzAVMoLeFzAjInh8OpMZSKJmJBJoJCHh3hj7TozBnST6POPuZAS1tsZ8uxEjKKp42fBaKaXQ544kDJBASurn+4X/+AFKe4i/Es2efAAAAABJRU5ErkJggg==" alt="Ejecutando docker-compose up" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/docker-compose-up.png" class="ab" width="722" height="488"></p><p>Si ingresamos en un navegador web con cada uno de los puertos (<code>3618</code>, <code>3620</code> y <code>3622</code>) veremos el mensaje que despliega cada uno de los servicios as√≠ como el saber que se encuentra en ejecuci√≥n.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAdklEQVR4AZXBMQoCMRBA0Z8xZIJp1rPZWFgv2HgUGxtvtHgU9QIhOzouggh2eS9czidnkbNyuz+YrhOqirtTa+UnUKIQt7s9ZkZWZZ6N8XAkaQICH+601pCV8DQjDsOGlzsBcHdSSvxbl8JXXNBD6CR0EjoJnd6xdiSrHNEN3gAAAABJRU5ErkJggg==" alt="App en ejecuci√≥n" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/browser-localhost.png" class="ab" width="718" height="492"></p><p>Y bueno, tres servicios ejecutandose en diferentes puertos del equipo local, es hora de comenzar con los pasos para el redireccionamiento.</p><h2>Instalar nginx</h2><p>Vamos a comenzar instalando <a href="https://nginx.org/">nginx</a> utilizando los siguientes comandos en la terminal.</p><pre class="code-segment line-numbers" data-language="shell"><code class="language-shell">sudo apt-get update
sudo apt-get install nginx
</code></pre><p>Despu√©s de la instalaci√≥n procedemos a ingresar en el navegador web la url <a href="http://localhost">http://localhost</a> donde deber√°s ver lo siguiente:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAxklEQVR4AZXBPU7DQBCA0W/Ws7Y3bgwikrvkHsANqJC4HKLhRJAydD4CJI1/Zge7iEQF4j15enxwBIZhYHuz5f72DnenrmuOH0feDu+4OyA0GtDnl1fMjBhLLGfqqkKjssqWMTPGcSQUAZtntL26pu97pumTGCNf7kzzzG63p6pLVpum4UJZpJRwd3I2Qiho25bz+YSZE0JBjAFVJaWEssg54+6YZWIsmSbFvaRpIoiyScKFsui6jpW7IyL8JvCDiPCXwD99A15lTfIW2WMkAAAAAElFTkSuQmCC" alt="P√°gina de bienvenida de nginx" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/welcome-to-nginx.png" class="ab" width="718" height="492"></p><p>Esta es la p√°gina de bienvenida de <a href="https://nginx.org/">nginx</a>, lo que nos indica que el servidor web est√° en ejecuci√≥n y se encuentra en escucha utilizando el puerto <code>80</code>.</p><h2>Deshaci√©ndonos de localhost</h2><p>Como ya lo mencionamos, <em>localhost</em> es el <strong>hostname</strong> del equipo local que est√° asignado a la direcci√≥n IP <strong>127.0.0.1</strong>, esta asignaci√≥n se realiza a nivel sistema operativo gracias a un archivo de configuraci√≥n de nombre <strong>hosts</strong> que dependiendo de cada sistema operativo se encuentra en <a href="https://en.wikipedia.org/wiki/Hosts_(file)#Location_in_the_file_system">diferente ubicaci√≥n</a>, este archivo es del tipo texto plano, lo que significa que lo puedes vizualizar y modificar con tu editor de textos preferido.</p><p>Minimamente, este archivo contiene algo similar a lo siguiente:</p><pre class="code-segment line-numbers" data-language="vim"><code class="language-vim">127.0.0.1  localhost
::1        localhost
</code></pre><p>La configuraci√≥n anterior es tan simple como decir que el hostname <em>localhost</em> est√° asingado a la direcci√≥n IP <em>127.0.0.1</em>, si agregamos cualquier hostname despu√©s de <em>localhost</em> estaremos asignando ese host a la direcci√≥n IP 127.0.0.1.</p><blockquote><p><strong>NOTA: El archivo hosts es un archivo del sistema operativo, por lo que si quieres modificarlo deber√°s hacerlo con permisos de administrador o root.</strong></p></blockquote><p>Vamos, edita el archivo <code>/etc/hosts</code> y agrega el hostname <em>mi-pagina-local.com</em> y luego ingresa a esa URL en el navegador.</p><pre class="code-segment line-numbers" data-language="vim"><code class="language-vim">127.0.0.1  localhost mi-pagina-local.com
::1        localhost
</code></pre><p>Ver√°s que se muestra lo mismo que al entrar a http://localhost/.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAuklEQVR4AZXBMU4DMRBA0T/2jCVnmwVSpEvacBAquGQajhX2CIhUa4+HpEBKBeI9eXt9CQFa65RSyDnTeydrRhC2T1uej0dEhPPHGT2d3nF3zAo+HPeBqlJK4UZEcO/klFjXFZ0fHlmWhdY+MTOIoPXOfn/ATLlXNxPKVa2ViGAMJ6XMPM9cLl+4ByllzBKqSq0V5WqMQUTgPjArtKZEFKbJQJRNFX4oV7vdjpuIQET4TeKOiPCXxD99A9UuRGUZdxGpAAAAAElFTkSuQmCC" alt="Lo mismo que localhost" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/mi-pagina-local.com.png" class="ab" width="718" height="492"></p><p>Y si agregas uno de los puertos de los servicios, tambi√©n ver√°s lo mismo.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAdklEQVR4AZXBIQ4CMRRF0dvf0hJqhrVhEDgEhrVgMCxpwm4Y1Qx/eGAICa7nhNv1IiEQPKaJ8T5SSkESrTV+AnVlpN3+gLuzLoWnLxxPZ2I0cs6EYCAxzzMWjcWdNAxbXhIBkETOmX+bWvlKH/QwOhmdjE5Gpzc6cyexbj9AnwAAAABJRU5ErkJggg==" alt="Lo mismo que el localhost:3618" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/mi-pagina-local.com-3618.png" class="ab" width="718" height="492"></p><p>Ahora bien, podemos sacar ventaja de esto para dejar de acceder a las aplicaciones web utilizando el hostname <strong>localhost</strong> y podemos utilizar algo como lo que mencion√© anteriormente. Vamos a agregar una nueva configuraci√≥n al archivo hosts para mapear la direcci√≥n IP local con unos nuevos hostnames:</p><pre class="code-segment line-numbers" data-language="vim"><code class="language-vim">127.0.0.1  localhost mi-pagina-local.com
::1        localhost

# Configuraci√≥n de host para aplicaciones
127.0.0.1  my-node-app.com
127.0.0.1  my-python-app.com
127.0.0.1  my-php-app.com
</code></pre><p>Probemos acceder a cualquiera de los hostnames que definimos en el archivo anterior con el navegador web, veremos que de igual manera aparece lo mismo que al ingresar a http://localhost/ y si agregamos los puertos de los servicios tambi√©n funcionar√°.</p><h2>Proxy Pass ‚Äî o redireccionando el tr√°fico ‚Äî</h2><p><a href="nginx">nginx</a> permite redireccionar el tr√°fico de una URL hacia otra utilizando la directiva <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a> del m√≥dulo <code>ngx_http_proxy_module</code>, es muy com√∫n utilizar est√° directiva para colocar varios servidores en un mismo espacio de URL.</p><p>Dentro del directorio <code>/etc/nginx/</code> se encuentra el archivo de configuraci√≥n <code>nginx.conf</code>, si lo editamos veremos que en alguna parte de la secci√≥n <code>http</code> contiene lo siguiente:</p><pre class="code-segment line-numbers" data-language="nginx"><code class="language-nginx">include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
</code></pre><p>Con esas l√≠neas se est√°n incluyendo todas las configuraciones que se encuentren dentro de esos directorios en la secci√≥n <code>http</code> del archivo principal, y si listamos el contenido del directorio <code>sites-enabled</code> veremos que el √∫nico archivo de nombre <code>default</code> es un elance simb√≥lico haciendo referencia al archivo tambi√©n de nombre <code>default</code> dentro del directorio <code>sites-available</code>.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAe0lEQVR4AZXBuwoCMRRF0Z2bOwoK/pTY+P+9jY1go6PjZPI4VoIIFlkrHA97gUBgMeLu1FKQQIg0z3xsPOL50kj3iVU0ahOv54SZMd5GQPzyUiolZ9JjodZGsIDUCLstNifWw4AANWHR8OvpzD8VmJbMN6OT0cnoZHR6A0J3OOeTpf0pAAAAAElFTkSuQmCC" alt="Sitios habilitados" title="Sitios habilitados" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/sites-enabled.png" class="ab" width="722" height="488"></p><p>Vamos a crear un archivo donde definiremos la configuraci√≥n para uno de los servicios creados con <a href="docker">docker</a>, comenzaremos con el servicio de node.js, para ello hay que crear el archivo <code>/etc/nginx/sites-available/my-node-app.com</code> al cual agregaremos la siguiente configuraci√≥n:</p><blockquote><p><strong>NOTA: El directorio <code>/etc/nginx</code> es un directorio en el que solamente se pueden crear √≥ modificar archivos con permisos de usuario root.</strong></p></blockquote><pre class="code-segment line-numbers" data-language="nginx"><code class="language-nginx">server {
    listen 80;
    listen [::]:80;

    server_name my-node-app.com;

    location ^~ / {
        proxy_pass http://localhost:3618;
    }
}
</code></pre><p>Ahora, crearemos un enlace simb√≥lico de nombre <code>my-node-app.com</code> dentro del directorio <code>sites-enabled</code> que har√° referenc√≠a al archivo posteriormente creado en el directorio <code>sites-available</code></p><pre class="code-segment line-numbers" data-language="shell"><code class="language-shell">sudo ln -s /etc/nginx/sites-available/my-node-app.com /etc/nginx/sites-enabled/my-node-app.com
</code></pre><p>Con esto tenemos la configuraci√≥n terminada y procederemos a reiniciar el servicio de <a href="nginx">nginx</a> con el siguiente comando:</p><pre class="code-segment line-numbers" data-language="shell"><code class="language-shell">sudo nginx -s reload
</code></pre><p>Listo, ¬°ingresa en el navegador web a <a href="http://my-node-app.com">http://my-node-app.com</a> y ver√°s lo mismo que el servicio ejecutandose en <a href="http://localhost:3618">http://localhost:3618</a>!</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAICAYAAADN5B7xAAAAfklEQVR4AZXBMQ7CMAxA0W/HcQqsdKMLcBwGhEDiXIiJGyExcJ6kbYCVLe/J5XSoCJRSQASPRoyJUjLDZmC/3aGquDvv1xO73R+MYyF1HdM0E81wd4IZQRVRIedMUOV4vmLrvmeuFQFqrbg7/9wTP4vlCvuihdJIaaQ0Uhp9AIeGHbcu+vAeAAAAAElFTkSuQmCC" alt="¬°my-node-app.com sin puerto!" title="¬°my-node-app.com sin puerto!" loading="lazy" data-src="/assets/blog/urls-amigables-utilizando-nginx-y-docker/my-node-app.png" class="ab" width="718" height="492"></p><h1>Funcionamiento de <code>proxy_pass</code> y <code>server_name</code></h1><p>La m√°gia que acabas de hacer, es posible gracias a las directivas <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a> y <a href="https://nginx.org/en/docs/http/server_names.html">server_name</a> las cuales hacen que la configuraci√≥n sea tan sencilla como hacer un <strong>match</strong> o <strong>if</strong>.</p><ul><li>El tag <code>server</code> define una nueva configuraci√≥n de servidor</li><li>Con el tag <code>listen 80</code> definimos que nginx escuche por el puerto 80.</li><li><code>server_name my-node-app.com</code> define el nombre del servidor, valor que se utilizar√° para compararlo con el header <code>host</code> que se env√≠e en la petici√≥n HTTP y mismo que defin√≠mos en el archivo <code>hosts</code> del sistema operativo.</li><li>Con los tags <code>location ^~ /</code> y <code>proxy_pass http://localhost:3618;</code> definimos que cuando se acceda a la URL ra√≠z √≥ <code>/</code> se realice el redireccionamiento de la petici√≥n HTTP al <code>host</code>:<code>puerto</code> especificados, en este caso <code>localhost</code>:<code>3618</code>.</li></ul><pre class="code-segment line-numbers" data-language="nginx"><code class="language-nginx">server {
    listen 80;
    listen [::]:80;

    server_name my-node-app.com;

    location ^~ / {
        proxy_pass http://localhost:3618;
    }
}

</code></pre><h1>Terminando</h1><p>Para finalizar, realiza exactamente los mismos pasos para los dos servicios restantes, creando dos nuevos archivos de configuraci√≥n y cambiando los valores de las directivas <code>proxy_pass</code> y <code>server_name</code>.</p><p>Ahora si puedes revisar nuevamente el diagrama del inicio para que entiendas un poco mas el proceso de redireccionamiento y si quieres conocer mas sobre las configuraciones que puedes hacer con <a href="https://nginx.org/">nginx</a> puedes revisar la documentaci√≥n de <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a> y <a href="https://nginx.org/en/docs/http/server_names.html">server_name</a>.</p><div id="disqus_thread"></div></section><script>var disqus_config=function(){this.page.url="https://roofox.dev/urls-amigables-utilizando-nginx-y-docker/index.html",this.page.identifier="https://roofox.dev/urls-amigables-utilizando-nginx-y-docker/index.html"},isDisqusAdded=!1</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><script src="/js/waypoints.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/prism.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-vim.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-bash.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-nginx.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-yaml.min.js"></script></article><script>var waypoint=new Waypoint({element:document.getElementById("disqus_thread"),handler:function(e){var t,d;isDisqusAdded||(console.log("Disqus added"),isDisqusAdded=!0,(d=(t=document).createElement("script")).src="https://byoigres.disqus.com/embed.js",d.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(d))},offset:"bottom-in-view"})</script><footer><div><p>Blog escrito por&nbsp; <a href="https://byoigr.es/" target="_blank" rel="noopener noreferrer">Sergio Flores</a></p></div></footer></main><script>!function(){if("loading"in HTMLImageElement.prototype){var e=document.querySelectorAll("img"),t=e.length;if(0<t)for(var s=0;s<t;s++)"dataset"in e[s]&&"src"in e[s].dataset&&(e[s].src=e[s].dataset.src),"srcset"in e[s].dataset&&(e[s].srcset=e[s].dataset.srcset)}else{var a=document.createElement("script");a.async=!0,a.src="https://cdn.jsdelivr.net/npm/lazysizes@5/lazysizes.min.js",document.body.appendChild(a)}}()</script></body></html>